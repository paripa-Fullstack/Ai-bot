# 🏗️ АРХИТЕКТУРА И СХЕМА РАБОТЫ БОТА

## 📊 Общая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                     TELEGRAM USER                           │
│                         👤                                  │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ Отправляет сообщения
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                  TELEGRAM BOT API                           │
│                      🤖                                      │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ Webhook / Long Polling
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              AI TELEGRAM BOT (Python)                       │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  TELEGRAM HANDLERS (python-telegram-bot)            │   │
│  │  • CommandHandler (/start, /help, /status, etc.)    │   │
│  │  • MessageHandler (текст, фото, контакты)           │   │
│  │  • CallbackQueryHandler (кнопки)                    │   │
│  │  • ConversationHandler (регистрация)                │   │
│  └──────────────┬──────────────────────────────────────┘   │
│                 │                                           │
│                 ▼                                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  BUSINESS LOGIC                                     │   │
│  │  • Проверка доступа пользователя                   │   │
│  │  • Обработка запросов                              │   │
│  │  • Управление подписками                           │   │
│  │  • Обработка платежей                              │   │
│  └──────────────┬──────────────────────────────────────┘   │
│                 │                                           │
│                 ▼                                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  DATA LAYER                                         │   │
│  │  • SQLite Database (bot_users.db)                  │   │
│  │  • API Integration (DeepInfra)                     │   │
│  └──────────────┬──────────────────────────────────────┘   │
└─────────────────┼───────────────────────────────────────────┘
                  │
         ┌────────┴────────┐
         ▼                 ▼
┌──────────────┐   ┌──────────────┐
│  SQLite DB   │   │ DeepInfra API│
│  bot_users.db│   │   (AI Model) │
│      💾      │   │      🧠      │
└──────────────┘   └──────────────┘
```

---

## 🔄 Процесс регистрации пользователя

```
START
  │
  ▼
/start команда
  │
  ▼
Проверка: Пользователь существует?
  │
  ├── ДА ──────────► Приветствие + Меню команд ──► END
  │
  └── НЕТ
      │
      ▼
  Запрос телефона 📱
      │
      ▼
  Получен телефон?
      │
      ├── ДА ──► Сохранить телефон
      │          │
      │          ▼
      │      Запрос местоположения 📍
      │          │
      │          ▼
      │      Получено местоположение?
      │          │
      │          ├── ДА ──► Сохранить координаты
      │          │          │
      │          │          ▼
      │          │      Запрос имени 📝
      │          │          │
      │          │          ▼
      │          │      Получено имя?
      │          │          │
      │          │          ├── ДА ──► Сохранить в БД
      │          │          │          │
      │          │          │          ▼
      │          │          │      Создать запись:
      │          │          │      • trial_uses = 5
      │          │          │      • is_subscribed = 0
      │          │          │          │
      │          │          │          ▼
      │          │          │      Приветственное сообщение
      │          │          │          │
      │          │          │          ▼
      │          │          │         END
      │          │          │
      │          │          └── НЕТ ──► Повтор запроса
      │          │
      │          └── НЕТ ──► Повтор запроса
      │
      └── НЕТ ──► Повтор запроса
```

---

## 💬 Процесс обработки AI запроса

```
Пользователь отправляет сообщение
  │
  ▼
Проверка доступа
  │
  ├─────────────────┬─────────────────┐
  │                 │                 │
  ▼                 ▼                 ▼
Trial uses > 0?  Подписка активна? Подписка истекла?
  │                 │                 │
  ├── ДА           ├── ДА            └── ДА
  │   │            │   │                  │
  │   ▼            │   ▼                  ▼
  │ Отправить      │ Отправить       Отказ + предложение
  │ запрос к AI    │ запрос к AI     оформить подписку
  │   │            │   │                  │
  │   ▼            │   ▼                  ▼
  │ DeepInfra API  │ DeepInfra API      END
  │   │            │   │
  │   ▼            │   ▼
  │ Получить ответ │ Получить ответ
  │   │            │   │
  │   ▼            │   ▼
  │ trial_uses--   │ total_requests++
  │   │            │   │
  │   ▼            │   ▼
  │ Сохранить      │ Сохранить
  │ в историю      │ в историю
  │   │            │   │
  │   └────────────┴───┘
  │                │
  │                ▼
  │           Отправить ответ
  │           пользователю
  │                │
  │                ▼
  │               END
  │
  └── НЕТ ──► Отказ + /subscribe
              │
              ▼
             END
```

---

## 💳 Процесс оформления подписки

```
/subscribe команда
  │
  ▼
Показать тарифы:
• Неделя - $5
• Месяц - $15
• Год - $100
  │
  ▼
Пользователь выбирает тариф
  │
  ▼
Показать крипто-адреса:
• TRC20 (USDT)
• BTC
  │
  ▼
Инструкция по оплате
  │
  ▼
Пользователь оплачивает
  │
  ▼
Пользователь отправляет скриншот чека 📸
  │
  ▼
Сохранить в БД:
• payments таблица
• approved = 0
• receipt_file_id
  │
  ▼
Уведомление администратору 👨‍💼
  │
  ▼
Администратор проверяет платеж
  │
  ├─────────────┬─────────────┐
  │             │             │
  ▼             ▼             ▼
ОДОБРЕН      ОТКЛОНЁН    НА ПРОВЕРКЕ
  │             │             │
  ▼             ▼             └─► Ожидание
UPDATE         Уведомить
payments       пользователя
approved=1        │
  │               ▼
  ▼              END
UPDATE users
is_subscribed=1
subscription_end
  │
  ▼
Уведомить пользователя
"Подписка активирована!"
  │
  ▼
END
```

---

## 🗄️ Структура базы данных

```
┌──────────────────────────────────────────────────────────┐
│                    bot_users.db                          │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  TABLE: users                                            │
├──────────────────────────────────────────────────────────┤
│  • user_id (PRIMARY KEY)      - Telegram User ID         │
│  • username                    - @username               │
│  • first_name                  - Имя                     │
│  • last_name                   - Фамилия                 │
│  • phone                       - Номер телефона          │
│  • location_lat                - Широта                  │
│  • location_lon                - Долгота                 │
│  • location_address            - Адрес (необязательно)   │
│  • name                        - Имя при регистрации     │
│  • registration_date           - Дата регистрации        │
│  • trial_uses (DEFAULT 5)      - Пробные использования   │
│  • is_subscribed (DEFAULT 0)   - Статус подписки         │
│  • subscription_end            - Дата окончания подписки │
│  • total_requests (DEFAULT 0)  - Всего запросов          │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  TABLE: payments                                         │
├──────────────────────────────────────────────────────────┤
│  • id (PRIMARY KEY)            - ID платежа              │
│  • user_id (FOREIGN KEY)       - ID пользователя         │
│  • subscription_type           - weekly/monthly/yearly   │
│  • payment_date                - Дата платежа            │
│  • receipt_file_id             - ID файла чека           │
│  • approved (DEFAULT 0)        - Статус одобрения        │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  TABLE: request_history                                  │
├──────────────────────────────────────────────────────────┤
│  • id (PRIMARY KEY)            - ID записи               │
│  • user_id (FOREIGN KEY)       - ID пользователя         │
│  • request_text                - Текст запроса           │
│  • response_text               - Ответ AI                │
│  • request_date                - Дата и время запроса    │
└──────────────────────────────────────────────────────────┘
```

---

## 🔐 Уровни доступа

```
┌─────────────────────────────────────────────────────────┐
│                   ПРОВЕРКА ДОСТУПА                      │
└─────────────────────────────────────────────────────────┘

   Пользователь делает запрос
            │
            ▼
┌───────────────────────────┐
│ Есть активная подписка?   │
│ (is_subscribed = 1 AND    │
│  subscription_end > now)  │
└────────┬──────────────────┘
         │
    ┌────┴────┐
    │         │
   ДА        НЕТ
    │         │
    │         ▼
    │  ┌───────────────────────┐
    │  │ Есть trial_uses > 0?  │
    │  └────────┬──────────────┘
    │           │
    │      ┌────┴────┐
    │      │         │
    │     ДА        НЕТ
    │      │         │
    │      │         ▼
    │      │    ❌ ОТКАЗ
    │      │    "Нет доступа"
    │      │    Предложить /subscribe
    │      │
    │      ▼
    │  ✅ ДОСТУП
    │  trial_uses--
    │  "Осталось X использований"
    │
    ▼
✅ БЕЗЛИМИТНЫЙ ДОСТУП
total_requests++
```

---

## 🚀 Компоненты системы

### 1. Основной бот (ai_telegram_bot.py)

```
┌────────────────────────────────────────┐
│  Handlers:                             │
│  • /start     - Регистрация            │
│  • /help      - Справка                │
│  • /status    - Статус пользователя    │
│  • /subscribe - Оформление подписки    │
│  • /history   - История запросов       │
│  • Text       - AI запросы             │
│  • Photo      - Чеки об оплате         │
│  • Contact    - Номер телефона         │
│  • Location   - Геопозиция             │
└────────────────────────────────────────┘
```

### 2. Админ-панель (admin_panel.py)

```
┌────────────────────────────────────────┐
│  Функции:                              │
│  1. 📊 Статистика                      │
│  2. 👥 Список пользователей            │
│  3. 💳 Список платежей                 │
│  4. ✅ Активация подписки              │
│  5. 🔍 Поиск пользователя              │
│  6. 📜 История запросов                │
│  7. 💰 Одобрение платежей              │
│  8. 🗑️ Удаление пользователя           │
│  9. 🔄 Сброс trial uses                │
└────────────────────────────────────────┘
```

### 3. Массовая рассылка (broadcast.py)

```
┌────────────────────────────────────────┐
│  Фильтры аудитории:                    │
│  • Все пользователи                    │
│  • Только с подпиской                  │
│  • Только на trial                     │
│  • Только с истекшим доступом          │
│                                        │
│  Возможности:                          │
│  • Шаблоны сообщений                   │
│  • Кастомные сообщения                 │
│  • Markdown форматирование             │
│  • Отчет о доставке                    │
└────────────────────────────────────────┘
```

### 4. Менеджер бота (bot_manager.sh)

```
┌────────────────────────────────────────┐
│  Команды:                              │
│  • start      - Запуск                 │
│  • stop       - Остановка              │
│  • restart    - Перезапуск             │
│  • status     - Статус и метрики       │
│  • logs       - Логи в реальном времени│
│  • backup     - Бэкап БД               │
│  • monitor    - Автоперезапуск         │
│  • install    - Установка как сервис   │
└────────────────────────────────────────┘
```

---

## 📡 Внешние интеграции

```
┌─────────────────────────────────────────────────────────┐
│                   EXTERNAL SERVICES                     │
└─────────────────────────────────────────────────────────┘

┌──────────────────┐
│  Telegram API    │  ◄── Получение/отправка сообщений
│  (Bot Token)     │
└──────────────────┘

┌──────────────────┐
│  DeepInfra API   │  ◄── AI обработка (Meta-Llama-3.1-70B)
│  (API Key)       │
└──────────────────┘

┌──────────────────┐
│  Crypto Networks │  ◄── Прием платежей
│  • TRC20 (USDT)  │
│  • Bitcoin (BTC) │
└──────────────────┘
```

---

## 📈 Метрики и мониторинг

```
Отслеживаемые метрики:

┌─────────────────────────────────────────┐
│  📊 БИЗНЕС-МЕТРИКИ                      │
├─────────────────────────────────────────┤
│  • Новые пользователи в день            │
│  • Активные пользователи                │
│  • Конверсия trial → paid               │
│  • Средний чек                          │
│  • MRR (Monthly Recurring Revenue)      │
│  • LTV (Lifetime Value)                 │
│  • Churn rate                           │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  ⚙️ ТЕХНИЧЕСКИЕ МЕТРИКИ                 │
├─────────────────────────────────────────┤
│  • Uptime бота                          │
│  • Среднее время ответа                 │
│  • Количество ошибок                    │
│  • Использование API лимитов            │
│  • Размер базы данных                   │
│  • Использование памяти/CPU             │
└─────────────────────────────────────────┘
```

---

## 🔒 Безопасность

```
┌─────────────────────────────────────────────────────┐
│              МЕРЫ БЕЗОПАСНОСТИ                      │
└─────────────────────────────────────────────────────┘

🔐 Данные пользователей
   │
   ├─► Хранятся локально (SQLite)
   ├─► Не передаются третьим лицам
   └─► Регулярные бэкапы

🔐 Платежи
   │
   ├─► Ручная проверка администратором
   ├─► Сохранение чеков
   └─► История всех транзакций

🔐 API ключи
   │
   ├─► Хранятся в коде (не в БД)
   ├─► Можно вынести в .env файл
   └─► Ограничены по rate limits

🔐 Доступ к серверу
   │
   ├─► Firewall настройки
   ├─► SSH ключи
   └─► Регулярные обновления
```

---

## 🎯 Жизненный цикл пользователя

```
День 1-7: TRIAL ПЕРИОД
  │
  ├─► Пользователь регистрируется
  ├─► Получает 5 бесплатных запросов
  ├─► Тестирует функционал
  └─► Видит предложение подписки
      │
      ▼
РЕШЕНИЕ: Оформить подписку?
      │
      ├─────────────┬─────────────┐
      │             │             │
     ДА            НЕТ       ПОЗЖЕ
      │             │             │
      ▼             ▼             ▼
АКТИВНЫЙ        ПОТЕРЯН      РЕТАРГЕТИНГ
ПОДПИСЧИК      (Churn)      (Рассылки)
      │
      └─► Использует бота регулярно
          │
          ▼
      Подписка истекает
          │
          ├─────────────┬─────────────┐
          │             │             │
       ПРОДЛИЛ      НЕ ПРОДЛИЛ    ПАУЗА
          │             │             │
          ▼             ▼             ▼
       LOYAL         CHURN        WINBACK
      USER                       CAMPAIGN
```

---

**Используйте эту схему для понимания работы системы! 🎯**
